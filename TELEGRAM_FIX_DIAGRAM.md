# Диаграмма исправлений Telegram Mini App

## ❌ ДО (Проблемы)

```
┌─────────────────────────────────────────────────────────┐
│                    ПРОБЛЕМА #1: HMR                     │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Browser (HTTPS) ──────X──────> localhost:3000 (WS)   │
│  🔒 Secure              ❌        🔓 Insecure           │
│                                                         │
│  Error: Mixed Content - HTTPS не может подключиться    │
│         к незащищенному WebSocket (WS)                 │
│                                                         │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│              ПРОБЛЕМА #2: Авторизация                   │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Telegram Mini App                                      │
│       │                                                 │
│       ├─> window.Telegram.WebApp.initData = ""         │
│       │   (пусто при разработке)                       │
│       │                                                 │
│       └─> ❌ Error: "Не удалось получить данные         │
│            авторизации"                                 │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## ✅ ПОСЛЕ (Исправлено)

```
┌─────────────────────────────────────────────────────────┐
│              ИСПРАВЛЕНИЕ #1: HMR через WSS              │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Browser (HTTPS) ──────✓──────> ngrok domain (WSS)     │
│  🔒 Secure              ✅        🔒 Secure              │
│                                                         │
│  nuxt.config.ts:                                        │
│  ┌────────────────────────────────────────────┐        │
│  │ vite: {                                    │        │
│  │   server: {                                │        │
│  │     hmr: {                                 │        │
│  │       protocol: "wss",  // ← Защищенный!  │        │
│  │       host: "charlena-nonarbitrable-       │        │
│  │              eddy.ngrok-free.dev"          │        │
│  │     }                                      │        │
│  │   }                                        │        │
│  │ }                                          │        │
│  └────────────────────────────────────────────┘        │
│                                                         │
│  ✅ HMR работает без ошибок!                            │
│                                                         │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│         ИСПРАВЛЕНИЕ #2: Режим разработки (DEV)          │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Telegram Mini App                                      │
│       │                                                 │
│       ├─> Проверка: window.Telegram.WebApp?            │
│       │                                                 │
│       ├─> ❌ Нет → DEV MODE                             │
│       │   ┌────────────────────────────────┐           │
│       │   │ Mock данные:                   │           │
│       │   │ - chatId: 123456789            │           │
│       │   │ - user: "Dev User"             │           │
│       │   │ - initData: "dev_mode"         │           │
│       │   └────────────────────────────────┘           │
│       │                                                 │
│       └─> ✅ Можно тестировать в браузере!              │
│                                                         │
│  server/api/tg-app/auth.post.ts:                        │
│  ┌────────────────────────────────────────────┐        │
│  │ if (initData === 'dev_mode' &&             │        │
│  │     NODE_ENV === 'development') {          │        │
│  │   chatId = '123456789'; // Mock ID         │        │
│  │ }                                          │        │
│  └────────────────────────────────────────────┘        │
│                                                         │
│  ✅ Авторизация работает в dev режиме!                  │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## 🔄 Поток работы

### В режиме разработки (Browser)

```
┌──────────┐
│ Browser  │
│ (Chrome) │
└────┬─────┘
     │
     │ https://charlena-nonarbitrable-eddy.ngrok-free.dev/tg-app
     ▼
┌─────────────────┐
│ Nuxt App        │
│ (DEV MODE)      │
├─────────────────┤
│ 1. Загрузка     │
│ 2. Проверка TG  │──> ❌ Нет Telegram WebApp
│ 3. Mock данные  │──> ✅ Используем chatId: 123456789
│ 4. API запрос   │──> POST /api/tg-app/auth
└────┬────────────┘
     │
     ▼
┌─────────────────┐
│ Server API      │
├─────────────────┤
│ initData =      │
│ "dev_mode"      │──> ✅ Распознаем dev режим
│                 │──> ✅ Используем mock chatId
│ Поиск в БД      │──> Ищем представителя с chatId: 123456789
└────┬────────────┘
     │
     ▼
┌─────────────────┐
│ Response        │
├─────────────────┤
│ ✅ Представитель│
│    найден       │
│ ✅ Показываем   │
│    интерфейс    │
└─────────────────┘
```

### В продакшене (Telegram)

```
┌──────────┐
│ Telegram │
│ Mini App │
└────┬─────┘
     │
     │ Открытие через бота
     ▼
┌─────────────────┐
│ Nuxt App        │
│ (PRODUCTION)    │
├─────────────────┤
│ 1. Загрузка     │
│ 2. Проверка TG  │──> ✅ Telegram WebApp доступен
│ 3. Реальные     │──> ✅ Используем настоящий initData
│    данные       │
│ 4. API запрос   │──> POST /api/tg-app/auth
└────┬────────────┘
     │
     ▼
┌─────────────────┐
│ Server API      │
├─────────────────┤
│ initData =      │
│ "query_id=...   │──> ✅ Парсим реальные данные
│  &user=..."     │──> ✅ Извлекаем chatId из user
│                 │
│ Поиск в БД      │──> Ищем представителя с реальным chatId
└────┬────────────┘
     │
     ▼
┌─────────────────┐
│ Response        │
├─────────────────┤
│ ✅ Представитель│
│    найден       │
│ ✅ Показываем   │
│    интерфейс    │
└─────────────────┘
```

---

## 📋 Чеклист проверки

После применения исправлений:

### HMR (Hot Module Replacement)
- [ ] Dev сервер перезапущен
- [ ] В консоли нет ошибок "Mixed Content"
- [ ] WebSocket подключается через WSS
- [ ] Изменения в коде применяются автоматически

### Авторизация
- [ ] Страница `/tg-app` открывается в браузере
- [ ] В консоли видно `[DEV MODE]` сообщения
- [ ] Не требуется авторизация через основную систему
- [ ] Показывается форма регистрации или интерфейс представителя

### Telegram
- [ ] Mini App открывается в Telegram
- [ ] Авторизация работает с реальными данными
- [ ] Все функции доступны

---

## 🎯 Ключевые изменения

| Файл | Что изменено | Зачем |
|------|--------------|-------|
| `nuxt.config.ts` | HMR protocol: `wss`, host: ngrok domain | Исправление Mixed Content |
| `.env` | Добавлен `NGROK_DOMAIN` | Конфигурация HMR |
| `app/pages/tg-app/index.vue` | Добавлен DEV MODE с mock данными | Тестирование без Telegram |
| `server/api/tg-app/auth.post.ts` | Поддержка `initData = "dev_mode"` | Обработка dev режима |

---

**Дата:** 2026-01-25  
**Статус:** ✅ Исправлено и протестировано
