# Отчет об очистке миграций

**Дата:** 17 января 2026  
**Статус:** ✅ Успешно завершено

## Проблема

В базе данных было обнаружено **44 записи о миграциях**, в то время как в реестре миграций (`migrator.ts`) было зарегистрировано только **32 миграции**. Это приводило к несоответствию и потенциальным ошибкам.

## Причина

В процессе разработки была удалена старая система объявлений (announcements), но записи о связанных миграциях остались в таблице `migrations` базы данных.

## Удаленные миграции

Следующие **12 устаревших миграций** были удалены из базы данных:

1. `20260111_041_group_announcements`
2. `20260111_042_training_requests`
3. `20260111_043_request_employees`
4. `20260111_044_request_history`
5. `20260111_045_add_representative_role`
6. `20260111_050_announcements`
7. `20260111_051_announcement_groups`
8. `20260111_052_announcement_requests`
9. `20260111_053_announcement_request_groups`
10. `20260111_054_announcement_request_employees`
11. `20260111_055_announcement_history`
12. `20260111_056_remove_group_announcement_fields`

## Текущее состояние

После очистки:
- ✅ Миграций в реестре: **32**
- ✅ Миграций в БД: **32**
- ✅ Ожидающих миграций: **0**
- ✅ Все миграции синхронизированы

## Актуальные миграции

Все 32 миграции в системе актуальны и применены:

### Базовая схема
1. `20251224_001_consolidated_schema` - Консолидированная миграция: полная схема базы данных

### Посещаемость и оценки
2. `20251225_020_attendance_grades` - Создание таблиц для системы посещаемости и оценок

### Сертификаты
3. `20251226_021_certificate_templates_extended` - Расширение шаблонов сертификатов
4. `20251226_022_certificate_visual_editor` - Визуальный редактор сертификатов
5. `20251229_023_certificate_validity_and_permissions` - Срок действия сертификатов
6. `20251229_025_unify_certificates` - Объединение таблиц сертификатов
7. `20260106_034_certificate_standalone` - Standalone сертификаты

### Telegram-бот
8. `20251229_024_telegram_bot_requests` - Журнал запросов Telegram-бота

### Пользователи и разрешения
9. `20251230_026_user_entity_links` - Связь Users с Students/Instructors
10. `20260113_044_add_user_relations` - Связь пользователей со студентами и инструкторами
11. `20260113_045_link_existing_users` - Связывание существующих пользователей
12. `20260115_051_add_user_search_indexes` - Индексы для поиска пользователей
13. `20260115_052_link_users_by_email` - Связывание пользователей по email

### Логирование
14. `20260103_027_activity_log_enum_expansion` - Расширение ENUM для activity_logs
15. `20260109_037_activity_log_action_types` - Расширение action_type ENUM

### Система тестирования
16. `20260104_028_testing_system` - Система тестирования студентов
17. `20260105_029_test_preview_mode` - Режим предпросмотра тестов
18. `20260105_030_preview_sessions_nullable_assignment` - Nullable assignment_id
19. `20260105_031_preview_sessions_nullable_student` - Nullable student_id
20. `20260105_032_multilang_questions` - Многоязычная поддержка вопросов
21. `20260106_033_grades_from_test` - Оценки из тестов

### Портал студента
22. `20260108_035_student_portal_tables` - Настройки и поддержка
23. `20260108_036_student_notifications` - Уведомления студентов

### Система посещаемости
24. `20260109_038_attendance_marking_system` - Система допуска отметок посещаемости
25. `20260109_039_fix_attendance_trigger` - Исправление триггера посещаемости
26. `20260109_040_backfill_marking_status` - Заполнение marking_status

### Система пересдач
27. `20260113_041_retake_system` - Система пересдач
28. `20260113_042_retake_linked_events` - Связанные пересдачи
29. `20260113_043_schedule_events_allowed_students` - Разрешенные студенты для событий

### Архивация
30. `20260114_046_group_archive_system` - Система архивации групп
31. `20260114_047_extend_files_for_groups` - Расширение таблицы files для отчетов групп
32. `20260114_048_course_archive_system` - Система архивации учебных программ

## Рекомендации

1. **При удалении функционала:** Всегда удаляйте соответствующие записи из таблицы `migrations`
2. **Перед деплоем:** Проверяйте статус миграций командой `npm run db:status`
3. **Документирование:** Фиксируйте все изменения в миграциях в документации

## Используемые скрипты

Для очистки были созданы вспомогательные скрипты:

- `server/database/check-migrations.ts` - Проверка миграций в БД
- `server/database/cleanup-migrations.ts` - Очистка устаревших миграций

Эти скрипты можно использовать в будущем для диагностики и очистки.
