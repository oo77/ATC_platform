# План реализации системы архивации

Данный документ описывает план технической реализации архивации для Учебных программ и Учебных групп.

## 1. Архивация Учебных Программ (Courses)

### 1.1 База данных

- **Статус:** ✅ Готово
- Используется существующая миграция `048_course_archive_system`:
  - `is_archived` (boolean)
  - `archived_at` (datetime)
  - `archived_by` (user_id)

### 1.2 Backend API (`/api/courses`)

- [x] **✅ Repository (`courseRepository.ts`)**:
  - Поле `isArchived` уже есть в интерфейсе `CourseFilters`.
  - Функция `getCoursesPaginated` уже поддерживает фильтр `isArchived`.
- [x] **✅ GET Endpoint (`index.get.ts`)**:
  - Уже принимает параметр `isArchived` из query string.
- [x] **✅ Endpoint Архивации (`[id]/archive.put.ts`)**:
  - Метод: `PUT`
  - URL: `/api/courses/:id/archive`
  - Body: `{ isArchived: boolean }`
  - Логика: проверка прав (ADMIN/MANAGER), установка флага, логирование.

### 1.3 Frontend (Страница Программ)

- [x] **✅ Табы ("Активные" / "Архив")**:
  - Реализованы в `/pages/programs/index.vue` (строки 125-165).
  - По умолчанию показываются активные.
  - При переключении запрашивается API с `isArchived=true/false`.
- [x] **✅ Управление архивацией**:
  - Кнопки "В архив" и "Восстановить" реализованы в `/pages/programs/[id].vue` (строки 214-258).
  - Логика архивации/восстановления реализована (строки 936-1003).
  - Доступно для Модераторов (проверка `canArchiveCourses`).

---

## 2. Ограничения на создание Групп

### 2.1 Backend (`/api/groups`)

- [x] **✅ Валидация при создании (`index.post.ts`)**:
  - Получение данных курса по `courseId`.
  - Если `course.isArchived === true`, возврат ошибки `400 Bad Request`.
  - Реализовано в строках 128-133.

---

## 3. Архивация Учебных Групп (Groups)

### 3.1 База данных

- **Статус:** ✅ Готово
- Используется миграция `046_group_archive_system`:
  - `is_archived` (boolean)
  - `archived_at` (datetime)
  - `archived_by` (user_id)
- **Примечание:** Дублирующая миграция `050` удалена.

### 3.2 Backend API (`/api/groups`)

- [x] **✅ Repository (`groupRepository.ts`)**:
  - Поле `isArchived` уже есть в интерфейсах.
  - Функция `getGroups` уже поддерживает фильтр `isArchived` (строки 656-659).
  - Функция `updateGroup` поддерживает `isArchived`, `archivedAt`, `archivedBy`.
- [x] **✅ Endpoint Архивации (`[id]/archive.put.ts`)**:
  - Метод: `PUT`
  - URL: `/api/groups/:id/archive`
  - Body: `{ isArchived: boolean }`
  - Логика: проверка прав (ADMIN/MANAGER), установка флага, логирование.

### 3.3 Frontend (Страница Групп)

- [x] **✅ Табы ("Текущие" / "Архив")**:
  - Реализованы в `/pages/groups/index.vue` (строки 155-195).
  - По умолчанию показываются текущие группы.
  - При переключении запрашивается API с `isArchived=true/false`.
  - Статус "Архив" отображается корректно (строки 692-693, 716-718).

### 3.4 Логика блокировки (Frontend)

Все ограничения применяются, если `group.isArchived === true`.

#### Страница группы (`/groups/[id]`)

- [ ] **Управление**: Скрыть/Отключить кнопки:
  - "Редактировать" (свойства группы).
  - "Удалить" (оставить доступной только для Админа, если требуется).
- [x] **Добавить кнопки архивации**:
  - [x] Кнопка "В архив" (для активных групп).
  - [x] Кнопка "Восстановить" (для архивных групп).
  - [x] Доступно для Модераторов (проверка `canArchiveGroups`).
- [x] **Студенты**:
  - [x] Скрыть кнопку "Управление слушателями".
  - [x] Скрыть/Отключить кнопки добавления/удаления.
- [x] **Документы**:
  - [x] Скрыть кнопку "Загрузить документ".
- [x] **Сертификаты**:
  - [x] Отключить возможность генерации/выдачи новых сертификатов.
- [x] **Дисциплины**:
  - [x] Отключить редактирование оценок/явок в журналах (перевести в режим Read-only).

#### Календарь и Расписание

- [x] **Компонент Календаря (`ScheduleCalendarView` или аналог)**:
  - [x] Для событий архивной группы установить свойство `editable: false`.
  - [x] Запретить Drag-and-Drop (изменение времени/даты).
  - [x] При клике на слот — запретить создание занятия.
  - [x] При клике на существующее занятие — открывать модальное окно только в режиме просмотра (Read-only).

---

## 4. Чек-лист для проверки (QA Checklist)

### Учебные программы (УП)

- [x] **Архивация УП**:
  - [x] Модератор может отправить УП в архив.
  - [x] УП исчезает из вкладки "Активные" и появляется в "Архив".
  - [x] Модератор может восстановить УП из архива.
- [x] **Влияние на Группы**:
  - [x] Попытка создать Группу по архивной УП -> Ошибка (на UI блокировка выбора или ошибка при сохранении).
  - [x] Существующие группы архивной УП продолжают работать (если сами не в архиве).

### Учебные группы

- [x] **Архивация Группы**:
  - [x] Админ (или Модератор) может заархивировать группу.
  - [x] Группа перемещается во вкладку "Архив".
- [x] **Блокировка функций (в архивной группе)**:
  - [x] Нет кнопки "Редактировать группу".
  - [x] Нет кнопки "Управление слушателями".
  - [x] Нет кнопки "Загрузить документ".
  - [x] Нельзя изменить оценки или явки в журнале.
  - [x] **Календарь**:
    - [x] Нельзя перетащить занятие группы.
    - [x] Нельзя изменить длительность занятия.
    - [ ] Нельзя создать новое занятие для этой группы.

### Ролевая модель

- [ ] **Модератор**:
  - [ ] Имеет доступ к редакции/архивации УП.
  - [ ] Видит архивные УП и Группы.
