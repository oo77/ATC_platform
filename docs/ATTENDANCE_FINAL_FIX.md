# Финальное исправление расчета посещаемости

## Дата: 14 января 2026

## Проблемы

1. **Процент посещаемости превышал 100%** на странице выдачи сертификатов и в журнале дисциплин
2. **Перездачи учитывались для всех студентов**, а не только для тех, кому они назначены
3. **Некорректные данные в таблице `attendance`**: `hours_attended` могло превышать длительность занятия

## Исправления

### 1. Страница выдачи сертификатов

**Файл:** `server/repositories/certificateTemplateRepository.ts`  
**Функция:** `checkStudentEligibility(studentId, groupId)`

#### Изменение 1: Фильтрация по `allowed_student_ids` (строки 763-778)

Добавлена фильтрация в SQL-запросы:

```sql
WHERE ... AND (
  se.allowed_student_ids IS NULL
  OR JSON_CONTAINS(se.allowed_student_ids, ?)
)
```

Применено к:

- Подсчету посещенных часов
- Подсчету запланированных часов
- Подсчету посещенных дисциплин

#### Изменение 2: Убрана зависимость от `attendance.max_hours` (строка 768)

**Было:**

```sql
SELECT
  COALESCE(SUM(a.hours_attended), 0) as total_attended_hours,
  COALESCE(SUM(a.max_hours), 0) as total_max_hours,  -- ❌ Проблема
  ...
```

**Стало:**

```sql
SELECT
  COALESCE(SUM(a.hours_attended), 0) as total_attended_hours,
  -- total_max_hours убрано, используем scheduled_hours ✅
  ...
```

Теперь `totalHours` берется только из `scheduledStats.scheduled_hours`, который рассчитывается из длительности занятий в `schedule_events`.

#### Изменение 3: Ограничение максимум 100% (строки 919-923)

**Было:**

```typescript
const totalAttendancePercent =
  totalHours > 0 ? (totalAttendedHours / totalHours) * 100 : 0;
```

**Стало:**

```typescript
const totalAttendancePercent =
  totalHours > 0 ? Math.min(100, (totalAttendedHours / totalHours) * 100) : 0;
```

Это защита от некорректных данных в `attendance`, где `hours_attended` может быть больше длительности занятия.

### 2. Страница журнала дисциплин

**Файл:** `server/api/attendance/journal.get.ts`  
**Строки:** 179-197

#### Изменение: Исключение скрытых ячеек (строки 179-197)

**Было:**

```typescript
const totalHoursAttended = cells.reduce(
  (sum, cell) => sum + (cell.attendance?.hoursAttended || 0),
  0
);

const totalMaxHours = cells.reduce((sum, cell) => {
  // Все ячейки учитывались ❌
  ...
}, 0);
```

**Стало:**

```typescript
const totalHoursAttended = cells.reduce(
  (sum, cell) => {
    if (cell.isHidden) return sum; // ✅ Пропускаем перездачи для других
    return sum + (cell.attendance?.hoursAttended || 0);
  },
  0
);

const totalMaxHours = cells.reduce((sum, cell) => {
  if (cell.isHidden) return sum; // ✅ Пропускаем перездачи для других
  ...
}, 0);
```

## Результат

### Страница выдачи сертификатов

✅ Процент посещаемости не превышает 100%  
✅ Перездачи учитываются только для назначенных студентов  
✅ Используются только запланированные часы из расписания  
✅ Защита от некорректных данных в `attendance`

### Страница журнала дисциплин

✅ Процент посещаемости корректно рассчитывается  
✅ Перездачи (isHidden) не учитываются для студентов, которым они не назначены  
✅ Статистика по группе корректна

## Примеры работы

### Пример 1: Студент без перездач

**Данные:**

- 10 обычных занятий (по 1 часу каждое)
- Студент посетил все 10
- Создана перездача для другого студента (1 час)

**До исправления:**

- Запланировано: 11 часов (10 обычных + 1 перездача)
- Посещено: 10 часов
- Посещаемость: 10/11 = **90.9%** ❌

**После исправления:**

- Запланировано: 10 часов (перездача не учитывается)
- Посещено: 10 часов
- Посещаемость: 10/10 = **100%** ✅

### Пример 2: Студент с перездачей

**Данные:**

- 10 обычных занятий (по 1 часу)
- Студент посетил 8 из 10
- Создана перездача для этого студента (1 час)
- Студент посетил перездачу

**До исправления:**

- Запланировано: 11 часов
- Посещено: 9 часов (8 + 1)
- Посещаемость: 9/11 = **81.8%** ✅ (правильно)

**После исправления:**

- Запланировано: 11 часов (10 обычных + 1 перездача для него)
- Посещено: 9 часов
- Посещаемость: 9/11 = **81.8%** ✅ (правильно)

### Пример 3: Некорректные данные в attendance

**Данные:**

- 1 занятие длительностью 1 час
- В `attendance` записано `hours_attended = 1.5` (ошибка)

**До исправления:**

- Запланировано: 1 час
- Посещено: 1.5 часа
- Посещаемость: 1.5/1 = **150%** ❌

**После исправления:**

- Запланировано: 1 час
- Посещено: 1.5 часа
- Посещаемость: Math.min(100, 150) = **100%** ✅

## Файлы изменены

1. `server/repositories/certificateTemplateRepository.ts`

   - Фильтрация по `allowed_student_ids`
   - Убрана зависимость от `attendance.max_hours`
   - Добавлено ограничение максимум 100%

2. `server/api/attendance/journal.get.ts`

   - Исключение скрытых ячеек (`isHidden`) из расчета

3. Документация:
   - `ATTENDANCE_CALCULATION_FIX.md`
   - `ATTENDANCE_FIX_SUMMARY.md`
   - `ATTENDANCE_FINAL_FIX.md` (этот файл)

## Тестирование

Рекомендуется проверить:

1. Страницу выдачи сертификатов для группы с перездачами
2. Журнал дисциплин для группы с перездачами
3. Убедиться, что процент посещаемости не превышает 100%
4. Проверить корректность для студентов с и без перездач
