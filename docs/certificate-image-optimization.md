# Оптимизация хранения изображений в шаблонах сертификатов

## Проблема

При сохранении шаблонов сертификатов с фоновыми изображениями возникала ошибка:

```
Got a packet bigger than 'max_allowed_packet' bytes
```

Это происходило потому, что изображения хранились как base64-строки внутри JSON поля `templateData`, что приводило к очень большим размерам данных (особенно для изображений высокого качества).

## Решение

Изображения теперь загружаются отдельно через API и хранятся как файлы на сервере. В `templateData` сохраняются только URL-адреса изображений.

### Преимущества:

- ✅ Значительно уменьшен размер данных шаблона
- ✅ Решена проблема с `max_allowed_packet`
- ✅ Ускорена загрузка и сохранение шаблонов
- ✅ Упрощено кэширование изображений браузером
- ✅ Возможность повторного использования изображений

## Реализованные изменения

### 1. API Endpoints

#### `POST /api/certificates/templates/[id]/upload-background`

Загружает фоновое изображение для шаблона.

**Параметры:**

- `background` (FormData) - файл изображения (JPG, PNG, WebP)
- Максимальный размер: 10MB

**Ответ:**

```json
{
  "success": true,
  "url": "/uploads/certificate-backgrounds/[id]_[uuid].jpg",
  "filename": "[id]_[uuid].jpg",
  "size": 1234567
}
```

#### `POST /api/certificates/templates/[id]/upload-image`

Загружает изображение для элемента шаблона (логотип, печать и т.д.).

**Параметры:**

- `image` (FormData) - файл изображения (JPG, PNG, WebP, SVG)
- Максимальный размер: 5MB

**Ответ:**

```json
{
  "success": true,
  "url": "/uploads/certificate-images/[id]_[uuid].png",
  "filename": "[id]_[uuid].png",
  "size": 123456
}
```

### 2. Структура файлов

```
public/
└── uploads/
    ├── certificate-backgrounds/  # Фоновые изображения
    │   ├── .gitignore
    │   └── [id]_[uuid].jpg
    └── certificate-images/        # Изображения элементов
        ├── .gitignore
        └── [id]_[uuid].png
```

### 3. Обновленные компоненты

#### `EditorToolbar.vue`

- Добавлен prop `templateId`
- Функции `onImageSelected` и `onBackgroundSelected` теперь загружают файлы через API
- Добавлены индикаторы загрузки `isUploadingImage` и `isUploadingBackground`

#### `EditorSidebar.vue`

- Добавлен prop `templateId`
- Функция `onImageSelected` теперь загружает файлы через API
- Добавлен индикатор загрузки `isUploadingImage`

#### `CertificateEditor.vue`

- Передает `templateId` в `EditorToolbar` и `EditorSidebar`

#### `useCertificateEditor.ts`

- Добавлены функции `uploadBackgroundImage` и `uploadElementImage`
- Экспортированы для использования в других компонентах

### 4. Конфигурация базы данных

В `server/utils/db.ts` добавлен параметр:

```typescript
maxAllowedPacket: 67108864, // 64MB
```

Это увеличивает лимит на уровне клиента MySQL для поддержки больших JSON-данных (на случай, если в шаблоне много элементов).

## Миграция существующих данных

Если у вас есть существующие шаблоны с base64-изображениями, они продолжат работать. Однако при следующем сохранении рекомендуется:

1. Открыть шаблон в редакторе
2. Заменить фоновое изображение (загрузить заново)
3. Заменить изображения элементов (если есть)
4. Сохранить шаблон

Это конвертирует base64-данные в файлы и уменьшит размер шаблона.

## Дополнительные настройки MySQL (опционально)

Для полной уверенности рекомендуется также увеличить `max_allowed_packet` на сервере MySQL:

### Временно (до перезапуска):

```sql
SET GLOBAL max_allowed_packet=67108864;
```

### Постоянно:

Добавьте в `my.ini` (Windows) или `my.cnf` (Linux/Mac):

```ini
[mysqld]
max_allowed_packet=64M
```

Затем перезапустите MySQL.

## Тестирование

1. Создайте новый шаблон сертификата
2. Загрузите фоновое изображение (желательно большое, >2MB)
3. Добавьте несколько изображений-элементов
4. Сохраните шаблон
5. Убедитесь, что сохранение прошло успешно
6. Проверьте, что изображения отображаются корректно

## Логирование

Все загрузки изображений логируются через `activityLogger`:

- Тип действия: `UPLOAD`
- Тип сущности: `CERTIFICATE_TEMPLATE_BACKGROUND` или `CERTIFICATE_TEMPLATE_IMAGE`
- Детали: имя файла и размер

## Безопасность

- ✅ Проверка типов файлов (только изображения)
- ✅ Ограничение размера файлов
- ✅ Уникальные имена файлов (UUID)
- ✅ Проверка существования шаблона перед загрузкой
- ✅ Логирование всех действий
