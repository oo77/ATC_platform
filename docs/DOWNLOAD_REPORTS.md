# Функционал скачивания документов в форматах PDF и Word

## Обзор

Реализован функционал для скачивания следующих документов в двух форматах (PDF и Word):

1. **Пустой журнал** - для ручного заполнения посещаемости
2. **Зачётная ведомость** - отчёт по дисциплине группы
3. **Ведомость выдачи сертификатов** - отчёт о выдаче сертификатов

## Расположение файлов

### Генераторы PDF (существующие)

- `app/utils/pdf/generateEmptyJournal.ts`
- `app/utils/pdf/generateGroupReport.ts`
- `app/utils/pdf/generateCertificateReport.ts`

### Генераторы DOCX (новые)

- `app/utils/docx/generateEmptyJournal.ts`
- `app/utils/docx/generateGroupReport.ts`
- `app/utils/docx/generateCertificateReport.ts`

### Компоненты с UI

- `app/pages/groups/[id]/index.vue` - Пустой журнал
- `app/pages/groups/journal/[slug].vue` - Зачётная ведомость
- `app/pages/groups/[id]/certificates.vue` - Ведомость выдачи сертификатов

### API для логирования

- `server/api/reports/log-download.post.ts` - Эндпоинт для логирования скачиваний

## Использование

### Для пользователей

1. **Пустой журнал**:
   - Перейти на страницу группы
   - Нажать на кнопку "Пустой журнал" (появится выпадающее меню)
   - Выбрать формат: "Скачать PDF" или "Скачать Word"

2. **Зачётная ведомость**:
   - Перейти в журнал дисциплины группы
   - Нажать на кнопку "Ведомость" (появится выпадающее меню)
   - Выбрать формат: "Скачать PDF" или "Скачать Word"

3. **Ведомость выдачи сертификатов**:
   - Перейти на страницу выдачи сертификатов группы
   - Нажать на кнопку "Ведомость" (появится выпадающее меню)
   - Выбрать формат: "Скачать PDF" или "Скачать Word"

### Для разработчиков

#### Структура генераторов DOCX

Генераторы DOCX используют простой подход с HTML-шаблонами:

```typescript
export async function generateDocumentDocx(data: DocumentData): Promise<void> {
  // 1. Создаём HTML-шаблон с данными
  const htmlContent = `
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="UTF-8">
      <style>
        /* CSS стили для форматирования */
      </style>
    </head>
    <body>
      <!-- Содержимое документа -->
    </body>
    </html>
  `;

  // 2. Создаём Blob и скачиваем как .doc файл
  const blob = new Blob([htmlContent], { type: "text/html" });
  const url = URL.createObjectURL(blob);

  const link = document.createElement("a");
  link.href = url;
  link.download = `Document_Name.doc`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
}
```

#### Логирование действий

Все скачивания автоматически логируются в журнал активности:

```typescript
await authFetch("/api/reports/log-download", {
  method: "POST",
  body: {
    reportType: "empty_journal" | "group_report" | "certificate_report",
    format: "pdf" | "docx",
    groupCode: string,
    groupId: string,
    disciplineName?: string, // опционально
  },
});
```

## Технические детали

### Формат Word (.doc)

Используется формат `.doc` (HTML-based) вместо `.docx` для:

- Простоты реализации
- Совместимости с Microsoft Word и LibreOffice
- Возможности редактирования перед печатью

### Логирование

Добавлен новый тип действия в систему логирования:

- **ActionType**: `DOWNLOAD` - "Скачал"
- **EntityType**: `GROUP_REPORT` - "отчет группы"

Все действия скачивания фиксируются с деталями:

- Тип отчёта
- Формат файла
- Код группы
- Дисциплина (для зачётной ведомости)
- Время скачивания

### Безопасность

- Все эндпоинты требуют авторизации
- Логирование не блокирует основной процесс (try-catch)
- Ошибки логирования не показываются пользователю

## Преимущества реализации

1. **Гибкость**: Пользователь может выбрать удобный формат
2. **Редактирование**: Word-документы можно корректировать перед печатью
3. **Аудит**: Все скачивания фиксируются в журнале активности
4. **UX**: Интуитивный интерфейс с выпадающими меню
5. **Масштабируемость**: Легко добавить новые форматы или типы отчётов

## Возможные улучшения

1. Использовать библиотеку `docx` для создания настоящих DOCX файлов
2. Добавить предпросмотр перед скачиванием
3. Добавить настройки форматирования документов
4. Реализовать шаблоны для кастомизации отчётов
5. Добавить экспорт в Excel для табличных данных
