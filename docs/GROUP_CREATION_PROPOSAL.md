# Предложение по реализации системы создания групп и архивации

## 1. Анализ требований

Требуется доработать процесс создания и управления учебными группами с учетом следующих ограничений:

- **Обязательная загрузка отчетов (PDF):** При создании группы необходимо загружать PDF-файл (основание создания), который должен храниться в строго определенной структуре директорий.
- **Ограничение прав на удаление:** Модераторы не должны иметь права удалять группы. Эта функция (или альтернатива в виде архивации) доступна только Администраторам.
- **Блокировка редактирования сроков:** Для завершенных групп изменение дат начала и окончания должно быть заблокировано, при этом возможность редактирования оценок и посещаемости должна сохраняться.

## 2. Предлагаемое решение

### 2.1 Изменения в Базе Данных

**Таблица `study_groups`:**

- Добавить поле `is_archived` (BOOLEAN DEFAULT FALSE).
  - Это позволит "скрывать" группы из активных списков без физического удаления данных, что важно для истории.
  - Поле `is_active` останется для текущего статуса (например, "идет обучение" vs "обучение приостановлено"), а `is_archived` будет означать окончательный перенос в архив.

**Таблица `files` (существующая):**

- Использовать категорию `group_report` (или добавить новую в ENUM) для хранения метаданных о PDF-отчете.
- Связывать файл с группой через поле `group_id`.

### 2.2 Организация хранения файлов

- **Структура пути:** `/storage/courses/{course_code}/{group_code}/reports/`
- **Формат:** Строго PDF.
- **Реализация:** При создании группы сервер будет:
  1. Получать код курса (для пути).
  2. Создавать директорию.
  3. Сохранять файл с валидацией MIME-типа.

### 2.3 Логика Backend (API)

1.  **POST `/api/groups` (Создание):**

    - Изменить метод обработки входящих данных с JSON на `multipart/form-data`.
    - Добавить валидацию наличия файла и его формата (PDF).
    - Логика транзакции: Группа создается только если файл успешно сохранен.

2.  **PUT `/api/groups/{id}` (Обновление):**

    - Добавить проверку: `Если (CurrentDate > ExistingGroup.endDate)`, то изменение полей `startDate` и `endDate` запрещено (игнорируется или возвращается ошибка).
    - Разрешить изменение статуса `is_archived` только пользователям с ролью `ADMIN`.

3.  **DELETE `/api/groups/{id}`:**
    - Ограничить доступ: Только роль `ADMIN`.
    - Для Модераторов API будет возвращать 403 Forbidden.

### 2.4 Изменения в Интерфейсе (UI)

1.  **Модальное окно (`GroupFormModal.vue`):**

    - Добавить поле `File Input` (accept=".pdf"). Поле обязательно только при создании новой группы.
    - Визуальное отображение загруженного файла при редактировании (ссылка на скачивание/просмотр).
    - Блокировка инпутов дат (disabled), если текущая дата больше даты окончания группы.

2.  **Список групп:**
    - Для Модераторов скрыть кнопку "Удалить".
    - Для Администраторов добавить кнопку/опцию "Архивировать" (которая переключает `is_archived`).
    - Фильтрация: По умолчанию показывать только не архивированные группы. Добавить таб/фильтр "Архив".

## 3. План реализации

1.  **Создание и запуск миграции БД:**
    - Добавить поле `is_archived` в таблицу `study_groups`.
2.  **Доработка Backend (API):**
    - Обновить `server/api/groups/index.post.ts` для поддержки загрузки файлов.
    - Реализовать логику сохранения файлов по указанному пути.
    - Обновить `server/api/groups/[id].put.ts` для проверки прав и блокировки дат.
    - Настроить права доступа в `server/api/groups/[id].delete.ts`.
3.  **Доработка Frontend (UI):**
    - Модифицировать `GroupFormModal.vue` для поддержки `FormData` и загрузки файлов.
    - Добавить логику блокировки полей дат.
    - Настроить видимость кнопок управления в зависимости от роли (Admin/Moderator).
4.  **Тестирование:**
    - Проверка путей сохранения файлов.
    - Проверка прав доступа.
    - Проверка ограничений редактирования завершенных групп.
