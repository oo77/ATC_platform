# Исправление предпросмотра шаблонов сертификатов

## Дата: 2026-02-16

## Проблема

Предпросмотр шаблона на странице `certificates/templates/[id]` отображал некорректные стили, особенно для текстовых элементов.
Это происходило потому, что использовался упрощенный механизм рендеринга через обычные `div` и `span` с приблизительными стилями ("эмпирическая" верстка), в то время как редактор использует полноценный HTML-генератор.

## Решение

Полностью заменен механизм предпросмотра на использование **iframe** с загрузкой сгенерированного HTML с сервера.
Это гарантирует, что предпросмотр выглядит идентично редактору иPDF-версии.

### Технические детали

#### 1. API Запрос

Добавлена функция `loadPreview()`, которая вызывает существующий API endpoint:
`GET /api/certificates/templates/[id]/preview`

Ответ содержит:

- `html`: полный HTML код сертификата
- `width`: ширина оригинального макета (напр. 1123px)
- `height`: высота оригинального макета (напр. 794px)
- `elementsCount`: количество элементов

#### 2. Компонент Vue (`templates/[id]/index.vue`)

**State:**

- `previewHtml`: хранит HTML код
- `previewData`: хранит размеры и метаданные
- `previewLoading`: статус загрузки

**Масштабирование:**
Использована библиотека `@vueuse/core` (`useElementSize`) для отслеживания ширины контейнера.
Вычисляется свойство `previewScale`:

```typescript
const previewScale = computed(() => {
  // ...
  const scale = availableWidth / targetWidth;
  return Math.min(Math.max(scale, 0.1), 1);
});
```

Это позволяет `iframe` всегда вписываться в доступное пространство, сохраняя пропорции, аналогично поведению `fit-content` но через `transform: scale()`.

**Рендеринг:**
Вместо множества `div` с `v-for`, используется один `iframe`:

```html
<iframe
  :srcdoc="previewHtml"
  class="w-full h-full border-0 block"
  sandbox="allow-same-origin"
  scrolling="no"
></iframe>
```

---

## Преимущества

1.  ✅ **100% Точность**: Предпросмотр использует тот же HTML/CSS движок, что и редактор.
2.  ✅ **Поддержка всех шрифтов**: Шрифты, подключенные в редакторе, будут работать и здесь.
3.  ✅ **Актуальность**: При кажом открытии страницы загружается свежая версия шаблона.

## Как тестировать

1.  Создать шаблон в редакторе, добавив текст с нестандартным шрифтом или расположением.
2.  Сохранить.
3.  Открыть страницу просмотра этого шаблона.
4.  Убедиться, что предпросмотр выглядит точно так же, как в редакторе.
5.  Изменить размер окна браузера -> предпросмотр должен корректно масштабироваться.
