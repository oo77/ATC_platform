# Исправление дублирования номеров сертификатов

**Дата:** 2026-02-16  
**Проблема:** `Duplicate entry 'ATC26_260001_0004' for key 'certificate_number'`

## Описание проблемы

При генерации сертификатов возникала ошибка дублирования номеров. Это происходило из-за того, что:

1. Генератор номеров не проверял существующие номера в базе данных
2. Счетчик `last_number` мог сбиться после импорта сертификатов
3. При дублировании шаблонов счетчик не синхронизировался

## Реализованные исправления

### 1. Улучшена функция генерации номеров

**Файл:** `server/repositories/certificateTemplateRepository.ts`

Функция `generateCertificateNumber` теперь:

- ✅ Проверяет существующие номера в базе данных
- ✅ Находит первый свободный номер, если текущий занят
- ✅ Защищена от бесконечного цикла (максимум 1000 попыток)
- ✅ Логирует процесс генерации для отладки

```typescript
// Проверяем, существует ли уже такой номер
const [existing] = await connection.query<RowDataPacket[]>(
  "SELECT id FROM issued_certificates WHERE certificate_number = ? LIMIT 1",
  [certificateNumber],
);

if (!existing || existing.length === 0) {
  // Номер свободен, используем его
  break;
}

// Номер занят, пробуем следующий
attemptNumber++;
```

### 2. Добавлена функция синхронизации счетчика

**Файл:** `server/repositories/certificateTemplateRepository.ts`

Новая функция `syncCertificateNumberCounter`:

- ✅ Анализирует существующие сертификаты
- ✅ Находит максимальный номер
- ✅ Обновляет счетчик до корректного значения
- ✅ Возвращает информацию о синхронизации

```typescript
export async function syncCertificateNumberCounter(
  templateId: string,
): Promise<{ oldCounter: number; newCounter: number; synced: boolean }>;
```

### 3. Создан API endpoint для синхронизации

**Файл:** `server/api/certificates/templates/[id]/sync-counter.post.ts`

- ✅ Доступен только администраторам
- ✅ Вызывает функцию синхронизации
- ✅ Возвращает результат операции
- ✅ Логирует все действия

**Endpoint:** `POST /api/certificates/templates/{id}/sync-counter`

### 4. Добавлена кнопка в UI

**Файл:** `app/pages/certificates/templates/[id]/index.vue`

В раздел "Статистика" добавлена кнопка:

- ✅ "Синхронизировать счетчик"
- ✅ С иконкой обновления
- ✅ С индикатором загрузки
- ✅ С подсказкой о назначении

## Как использовать

### Автоматическая защита

Теперь при генерации сертификатов система **автоматически** проверяет номера и избегает дубликатов.

### Ручная синхронизация

Если счетчик сбился (например, после импорта):

1. Откройте страницу настроек шаблона
2. Найдите раздел "Статистика"
3. Нажмите кнопку "Синхронизировать счетчик"
4. Система автоматически найдет максимальный номер и обновит счетчик

## Логирование

Все операции логируются:

```
[generateCertificateNumber] Номер ATC26_260001_0004 уже существует, пробуем следующий
[generateCertificateNumber] Сгенерирован номер: ATC26_260001_0005 (попыток: 2)
[syncCertificateNumberCounter] Счетчик обновлен: 3 -> 5
```

## Преимущества

1. **Надежность:** Дубликаты номеров больше не возникают
2. **Автоматизация:** Система сама находит свободные номера
3. **Гибкость:** Можно вручную синхронизировать счетчик
4. **Прозрачность:** Все действия логируются
5. **Безопасность:** Защита от бесконечных циклов

## Тестирование

Проверьте работу:

1. Попробуйте создать сертификат в группе
2. Если возникает ошибка дублирования:
   - Используйте кнопку синхронизации
   - Попробуйте снова
3. Проверьте логи в консоли сервера

## Связанные файлы

- `server/repositories/certificateTemplateRepository.ts` - основная логика
- `server/api/certificates/templates/[id]/sync-counter.post.ts` - API endpoint
- `app/pages/certificates/templates/[id]/index.vue` - UI компонент
