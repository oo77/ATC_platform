# Исправления шаблонов сертификатов

## Дата: 2026-02-16

## Проблемы и решения

### 1. ✅ Предпросмотр шаблона не обновлялся после сохранения

**Проблема:**
После сохранения шаблона через редактор, при возврате на страницу шаблона (`/certificates/templates/[id]`) предпросмотр показывал старые данные.

**Причина:**
Страница загружала данные шаблона только один раз при монтировании компонента (`onMounted`). При возврате с редактора компонент не перемонтировался, а просто активировался, поэтому данные не обновлялись.

**Решение:**

- Добавлен хук `onActivated` в `app/pages/certificates/templates/[id]/index.vue`
- Теперь при каждом возврате на страницу (активации компонента) данные шаблона автоматически перезагружаются
- Предпросмотр всегда показывает актуальную версию шаблона

**Изменённые файлы:**

- `app/pages/certificates/templates/[id]/index.vue`
  - Добавлен импорт `onActivated` из Vue
  - Добавлен хук `onActivated(() => { loadTemplate(); })`

---

### 2. ✅ Добавлена функция дублирования шаблонов

**Проблема:**
Не было возможности дублировать существующие шаблоны для создания похожих сертификатов с минимальными изменениями.

**Решение:**
Реализована полноценная функция дублирования шаблонов:

#### Backend (API):

- **Новый эндпоинт:** `POST /api/certificates/templates/[id]/duplicate`
- **Файл:** `server/api/certificates/templates/[id]/duplicate.post.ts`
- **Функциональность:**
  - Копирует все данные оригинального шаблона
  - Создаёт новый шаблон с названием "(копия)"
  - Копирует: `templateData`, `layout`, `backgroundUrl`, `variables`, `qrSettings`
  - Новый шаблон по умолчанию неактивен (`isActive: false`)
  - Логирует действие в журнал активности

#### Frontend (UI):

**Страница шаблона** (`app/pages/certificates/templates/[id]/index.vue`):

- Добавлена кнопка "Дублировать шаблон" в секции "Действия"
- Добавлен state `isDuplicating` для отображения процесса
- Добавлена функция `duplicateTemplate()`
- После успешного дублирования пользователь перенаправляется на страницу нового шаблона

**Список шаблонов** (`app/pages/certificates/templates/index.vue`):

- Добавлена кнопка дублирования в overlay действий на карточке шаблона
- Иконка: зелёная иконка копирования
- Добавлена функция `handleDuplicate(template)`
- После дублирования пользователь перенаправляется на страницу нового шаблона

---

## Преимущества реализации

### Автообновление предпросмотра:

✅ Пользователь всегда видит актуальную версию шаблона  
✅ Не нужно вручную обновлять страницу  
✅ Улучшен UX при работе с редактором

### Дублирование шаблонов:

✅ Экономия времени при создании похожих сертификатов  
✅ Минимальные усилия для изменения почти одинаковых шаблонов  
✅ Безопасное копирование всех настроек и данных  
✅ Новый шаблон неактивен по умолчанию (избегаем случайного использования)  
✅ Доступно из двух мест: страница шаблона и список шаблонов

---

## Использование

### Дублирование шаблона:

**Способ 1 - Из списка шаблонов:**

1. Перейти на `/certificates/templates`
2. Навести курсор на карточку шаблона
3. Нажать на зелёную иконку копирования в overlay
4. Автоматический переход на страницу нового шаблона

**Способ 2 - Со страницы шаблона:**

1. Открыть шаблон `/certificates/templates/[id]`
2. В секции "Действия" нажать кнопку "Дублировать шаблон"
3. Автоматический переход на страницу нового шаблона

### Работа с предпросмотром:

1. Открыть редактор шаблона
2. Внести изменения
3. Сохранить шаблон
4. Вернуться на страницу шаблона (кнопка "Назад" или через навигацию)
5. ✅ Предпросмотр автоматически обновится с новыми данными

---

## Технические детали

### API Эндпоинт дублирования:

```typescript
POST /api/certificates/templates/[id]/duplicate

Response:
{
  success: true,
  template: CertificateTemplate,
  message: "Шаблон успешно дублирован"
}
```

### Логирование:

Все действия дублирования логируются в `activity_logs` с типом:

- `action`: "CREATE"
- `entity_type`: "CERTIFICATE_TEMPLATE"
- `details`: содержит информацию об оригинальном шаблоне

---

## Тестирование

### Проверить автообновление:

1. ✅ Открыть любой шаблон
2. ✅ Перейти в редактор
3. ✅ Изменить название элемента или добавить новый элемент
4. ✅ Сохранить
5. ✅ Вернуться на страницу шаблона
6. ✅ Убедиться, что предпросмотр показывает новые изменения

### Проверить дублирование:

1. ✅ Создать шаблон с настройками
2. ✅ Дублировать через кнопку
3. ✅ Проверить, что новый шаблон имеет:
   - Название с суффиксом "(копия)"
   - Все данные оригинала (templateData, variables, qrSettings)
   - Статус "Неактивен"
4. ✅ Проверить, что можно редактировать новый шаблон независимо от оригинала

---

## Файлы изменений

### Новые файлы:

- `server/api/certificates/templates/[id]/duplicate.post.ts` - API эндпоинт дублирования

### Изменённые файлы:

- `app/pages/certificates/templates/[id]/index.vue` - автообновление + кнопка дублирования
- `app/pages/certificates/templates/index.vue` - кнопка дублирования в списке
