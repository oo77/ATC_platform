# Исправление логики доступности тестов

## Проблема

Старые тесты (созданные задним числом) оставались доступными, хотя должны были быть просрочены. Статус "Просрочено" не отображался корректно.

## Причина

Система использовала поля `start_date` и `end_date` из таблицы `test_assignments` для определения доступности тестов. Однако эти поля:

1. Не всегда заполнены
2. Не учитывают время начала и окончания **самого занятия** из `schedule_events`

## Решение

### Изменена логика определения сроков доступности

**Было:**

- Использовались `test_assignments.start_date` и `test_assignments.end_date`
- Эти поля могли быть `NULL` или не соответствовать времени занятия

**Стало:**

- Используются `schedule_events.start_time` и `schedule_events.end_time`
- Это время начала и окончания **занятия** (обычного или перездачного)

### Как это работает

#### Для обычных тестов:

```
Тест доступен с: schedule_events.start_time (начало занятия)
Тест доступен до: schedule_events.end_time (конец занятия)
```

#### Для перездач:

```
Тест доступен с: schedule_events.start_time (начало перездачи)
Тест доступен до: schedule_events.end_time (конец перездачи)
```

#### Учет даты окончания курса:

Если курс завершается раньше, чем заканчивается занятие, используется дата окончания курса (`study_groups.end_date`).

## Измененные файлы

### 1. `server/repositories/testAssignmentRepository.ts`

**Изменения в SQL-запросе (строки 519-561):**

- Добавлены поля `se.start_time as event_start_time` и `se.end_time as event_end_time`

**Изменения в маппинге результатов (строки 569-595):**

```typescript
// Было:
start_date: row.start_date || null,
end_date: endDate,

// Стало:
const eventStartTime = row.event_start_time ? new Date(row.event_start_time) : null;
const eventEndTime = row.event_end_time ? new Date(row.event_end_time) : null;
// ...
start_date: eventStartTime,
end_date: finalEndDate,
```

## Результат

✅ Тесты теперь корректно показывают статус "Просрочено" для старых занятий
✅ Доступность определяется по времени занятия (обычного или перездачного)
✅ Перездачи работают корректно - их доступность определяется временем перездачного занятия
✅ Учитывается дата окончания курса как крайний срок

## Пример

### Занятие создано 10 января 2026, время 09:00-11:50

- `start_time`: 2026-01-10 09:00:00
- `end_time`: 2026-01-10 11:50:00

**Результат:**

- Тест доступен: с 09:00 до 11:50 10 января 2026
- После 11:50 10 января 2026 → статус "Просрочено" (оранжевый)

### Перездача создана на 20 января 2026, время 14:00-16:50

- `start_time`: 2026-01-20 14:00:00
- `end_time`: 2026-01-20 16:50:00

**Результат:**

- Тест доступен: с 14:00 до 16:50 20 января 2026
- После 16:50 20 января 2026 → статус "Просрочено" (оранжевый)

## Важно

Поля `test_assignments.start_date` и `test_assignments.end_date` больше **не используются** для определения доступности тестов. Они остаются в таблице для совместимости, но не влияют на логику.
