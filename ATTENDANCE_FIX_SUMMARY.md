# Итоговый отчет: Исправление расчета посещаемости

## Проблемы

1. **Процент посещаемости превышал 100%** на странице выдачи сертификатов
2. **Перездачи учитывались для всех студентов**, а не только для тех, кому они назначены
3. **Искажение статистики**: студенты, не участвующие в перездачах, видели снижение процента посещаемости

## Корневая причина

В функции `checkStudentEligibility` (`certificateTemplateRepository.ts`) при расчете посещаемости учитывались **все** занятия группы, включая перездачи, независимо от того, назначены ли они конкретному студенту.

### Пример проблемы:

```
Группа: 10 обычных занятий
Студент А: посетил все 10 занятий (100%)
Студент Б: посетил 8 из 10 занятий (80%)

Создана перездача для студента Б (1 занятие)

НЕПРАВИЛЬНЫЙ расчет (до исправления):
- Всего занятий в группе: 11 (10 обычных + 1 перездача)
- Студент А: 10/11 = 90.9% ❌ (хотя должно быть 100%)
- Студент Б: 8/11 = 72.7% ❌ (хотя должно быть 80% или выше после перездачи)

ПРАВИЛЬНЫЙ расчет (после исправления):
- Студент А: 10/10 = 100% ✅ (перездача не учитывается)
- Студент Б: 8/11 = 72.7% или 9/11 = 81.8% ✅ (если посетит перездачу)
```

## Решение

Добавлена фильтрация по `allowed_student_ids` во все SQL-запросы, связанные с расчетом посещаемости.

### Логика фильтрации:

```sql
WHERE ... AND (
  se.allowed_student_ids IS NULL          -- Обычное занятие (для всех)
  OR JSON_CONTAINS(se.allowed_student_ids, ?) -- Перездача, и студент в списке
)
```

## Измененные файлы и функции

### `server/repositories/certificateTemplateRepository.ts`

Функция: `checkStudentEligibility(studentId, groupId)`

#### 1. Подсчет посещенных часов (строки 750-765)

**Добавлена фильтрация:**

```sql
WHERE a.student_id = ?
  AND se.group_id = ?
  AND (
    se.allowed_student_ids IS NULL
    OR JSON_CONTAINS(se.allowed_student_ids, ?)
  )
```

#### 2. Подсчет запланированных часов (строки 767-777)

**Добавлена фильтрация:**

```sql
WHERE se.group_id = ?
  AND (
    se.allowed_student_ids IS NULL
    OR JSON_CONTAINS(se.allowed_student_ids, ?)
  )
```

#### 3. Подсчет посещенных дисциплин (строки 835-848)

**Добавлена фильтрация:**

```sql
WHERE a.student_id = ?
  AND se.group_id = ?
  AND a.hours_attended > 0
  AND (
    se.allowed_student_ids IS NULL
    OR JSON_CONTAINS(se.allowed_student_ids, ?)
  )
```

## Влияние на систему

### Страница выдачи сертификатов (`/groups/[id]/certificates`)

**Источник данных:**

- API: `GET /api/certificates/issue/[groupId]`
- Использует: `checkStudentEligibility()` для каждого студента
- Отображает: `totalAttendancePercent` (из `eligibility.attendancePercent`)

**Результат исправления:**
✅ Процент посещаемости корректно рассчитывается (не превышает 100%)  
✅ Перездачи учитываются только для назначенных студентов  
✅ Студенты без перездач видят корректный процент

### Страница журнала дисциплин (`/groups/journal/[slug]`)

**Источник данных:**

- API: `GET /api/attendance/journal?groupId=...&disciplineId=...`
- Расчет: `totalHoursAttended / totalMaxHours * 100`
- Отображает: `attendancePercent` для каждого студента

**Проблема:**
В расчете `totalMaxHours` учитывались **все** занятия, включая перездачи с `isHidden === true` (перездачи для других студентов).

**Решение:**
Добавлена проверка `if (cell.isHidden) return sum;` в расчет:

- `totalHoursAttended` (строки 179-187)
- `totalMaxHours` (строки 189-197)

**Результат исправления:**
✅ Процент посещаемости корректно рассчитывается в журнале  
✅ Перездачи не учитываются для студентов, которым они не назначены  
✅ Статистика по группе корректна

### Другие места использования

Функция `checkStudentEligibility` также используется при:

- Выдаче сертификатов (проверка допуска)
- Отображении статистики по группе
- Telegram-боте (уведомления о допуске)

Все эти места теперь работают корректно.

## Тестирование

### Сценарий 1: Студент без перездач

**Дано:**

- 10 обычных занятий в группе
- Студент посетил все 10
- Создана перездача для другого студента

**Ожидаемый результат:**

- Посещаемость: 100% ✅

### Сценарий 2: Студент с перездачей

**Дано:**

- 10 обычных занятий в группе
- Студент посетил 8 из 10
- Создана перездача для этого студента
- Студент посетил перездачу

**Ожидаемый результат:**

- Всего занятий для студента: 11 (10 обычных + 1 перездача)
- Посещено: 9 (8 обычных + 1 перездача)
- Посещаемость: 81.8% ✅

### Сценарий 3: Несколько перездач

**Дано:**

- 10 обычных занятий
- Перездача 1 для студентов А и Б
- Перездача 2 для студента В

**Ожидаемый результат:**

- Студент А: учитываются 10 обычных + перездача 1 = 11 занятий
- Студент Б: учитываются 10 обычных + перездача 1 = 11 занятий
- Студент В: учитываются 10 обычных + перездача 2 = 11 занятий
- Студент Г (без перездач): учитываются только 10 обычных занятий

## Документация

Создан файл `ATTENDANCE_CALCULATION_FIX.md` с подробным описанием проблемы и решения.

## Дата исправления

14 января 2026 года
