import{M as o,f as w}from"./GLV6bXvn.js";import{u as j}from"./DlZaGH1J.js";import{u as z}from"./DVL-QcDc.js";import{s as A}from"./CRUGdXr-.js";let f=null,u=0;const S=5,x=()=>{const l=o("import_is_importing",()=>!1),m=o("import_is_analyzing",()=>!1),p=o("import_job_id",()=>null),r=o("import_current_step",()=>1),d=o("import_file_name",()=>null),y=o("import_type",()=>null),_=o("import_analysis",()=>null),n=o("import_progress",()=>null),a=o("import_error",()=>null),{authFetch:g}=j(),{error:c}=z(),h=()=>{i(),l.value=!1,m.value=!1,p.value=null,r.value=1,d.value=null,y.value=null,_.value=null,n.value=null,a.value=null,u=0},i=()=>{f&&(clearInterval(f),f=null)},M=async t=>{m.value=!0,a.value=null,d.value=t.name,y.value="student";try{const s=new FormData;s.append("file",t);const e=await g("/api/students/import/analyze",{method:"POST",body:s});if(e.success&&e.analysis)_.value=e.analysis,r.value=2;else{const v=e.error||"Ошибка анализа файла";a.value=v,c(v)}}catch(s){const e=s instanceof Error?s.message:"Ошибка анализа файла";console.error("Ошибка анализа файла:",s),a.value=e,c(e)}finally{m.value=!1}},b=async t=>{if(!t){c("Файл не выбран");return}l.value=!0,r.value=3,a.value=null,u=0;try{const s=new FormData;s.append("file",t);const e=await g("/api/students/import/execute",{method:"POST",body:s});if(e.success&&e.jobId)p.value=e.jobId,I();else{const v=e.error||"Ошибка запуска импорта";a.value=v,c(v),r.value=2,l.value=!1}}catch(s){const e=s instanceof Error?s.message:"Ошибка запуска импорта";console.error("Ошибка запуска импорта:",s),a.value=e,c(e),r.value=2,l.value=!1}},I=()=>{i(),u=0,f=A(async()=>{if(!p.value){i();return}try{const t=await g(`/api/students/import/status/${p.value}`,{method:"GET"});t.success&&t.status&&(n.value=t.status,u=0,(t.status.status==="completed"||t.status.status==="failed")&&(i(),l.value=!1,r.value=4))}catch(t){u++,console.error(`Ошибка получения статуса импорта (попытка ${u}/${S}):`,t),u>=S&&(i(),a.value="Потеряна связь с сервером. Проверьте статус импорта вручную.",c("Потеряна связь с сервером"))}},1e3)},E=()=>{h()},R=w(()=>!n.value||!n.value.totalRows?0:Math.round(n.value.processedRows/n.value.totalRows*100)),P=w(()=>l.value||r.value>1);return{isImporting:l,isAnalyzing:m,jobId:p,currentStep:r,fileName:d,analysis:_,progress:n,error:a,importType:y,percentage:R,hasActiveSession:P,analyzeStudentImport:M,executeStudentImport:b,cancelImport:E,reset:h,startPolling:I,stopPolling:i}};export{x as u};
