import{M as s,f as w}from"./GLV6bXvn.js";import{u as k}from"./DlZaGH1J.js";import{u as A}from"./DVL-QcDc.js";const J=()=>{const u=s("cert_issue_is_issuing",()=>!1),i=s("cert_issue_is_paused",()=>!1),g=s("cert_issue_current_job",()=>null),f=s("cert_issue_processed",()=>0),d=s("cert_issue_total",()=>0),_=s("cert_issue_current_student",()=>""),n=s("cert_issue_success",()=>0),p=s("cert_issue_warning",()=>0),l=s("cert_issue_error",()=>0),c=s("cert_issue_results",()=>[]),m=s("cert_issue_errors",()=>[]),o=s("cert_issue_completed",()=>!1),{authFetch:N}=k(),{success:$,error:S}=A(),y=w(()=>d.value===0?0:Math.round(f.value/d.value*100)),D=w(()=>u.value||o.value&&c.value.length>0),M=async t=>{if(u.value){console.warn("[CertificateIssue] Выдача уже выполняется");return}g.value=t,d.value=t.studentIds.length,f.value=0,n.value=0,p.value=0,l.value=0,c.value=[],m.value=[],o.value=!1,i.value=!1,u.value=!0,console.log(`[CertificateIssue] Начинаем массовую выдачу: ${t.studentIds.length} студентов для группы ${t.groupCode}`);const I=t.studentData,C=new Set;for(let v=0;v<I.length;v++){if(i.value||!u.value){console.log("[CertificateIssue] Выдача приостановлена или отменена");break}const e=I[v];if(!e){console.warn(`[CertificateIssue] Студент с индексом ${v} не найден, пропускаем`);continue}if(C.has(e.id)){console.warn(`[CertificateIssue] Студент ${e.fullName} уже обработан, пропускаем`);continue}C.add(e.id),_.value=e.fullName,f.value=v+1;try{const r=await N(`/api/certificates/issue/${t.groupId}`,{method:"POST",body:{templateId:t.templateId,studentIds:[e.id],issueDate:t.issueDate,instructorId:t.instructorId,expiryMode:t.expiryMode,overrideWarnings:!e.isEligible}});if(r.success&&r.results.length>0){const a=r.results[0];if(!a){console.warn(`[CertificateIssue] Результат для ${e.fullName} не получен`);continue}c.value.push(a),a.success?a.warnings&&a.warnings.length>0?p.value++:n.value++:(l.value++,m.value.push({studentName:a.studentName,error:a.error||"Неизвестная ошибка"}))}}catch(r){console.error(`[CertificateIssue] Ошибка выдачи для ${e.fullName}:`,r);const a={studentId:e.id,studentName:e.fullName,success:!1,error:r.data?.message||r.message||"Ошибка выдачи"};c.value.push(a),l.value++,m.value.push({studentName:e.fullName,error:a.error})}v<I.length-1&&await new Promise(r=>setTimeout(r,100))}u.value=!1,o.value=!0,_.value="",console.log(`[CertificateIssue] Выдача завершена: ${n.value} успешно, ${l.value} ошибок`),n.value>0&&$(`Выдано ${n.value} сертификатов для группы ${t.groupCode}`),l.value>0&&S(`${l.value} ошибок при выдаче сертификатов`)},x=()=>{u.value&&(i.value=!0)},P=()=>{u.value=!1,i.value=!1,o.value=!0},h=()=>{u.value=!1,i.value=!1,o.value=!1,g.value=null,f.value=0,d.value=0,_.value="",n.value=0,p.value=0,l.value=0,c.value=[],m.value=[]};return{isIssuing:u,isPaused:i,isCompleted:o,currentJob:g,processedCount:f,totalCount:d,currentStudentName:_,successCount:n,warningCount:p,errorCount:l,results:c,errors:m,percentage:y,hasActiveIssue:D,startBulkIssue:M,pauseIssue:x,cancelIssue:P,reset:h,dismissNotification:()=>{o.value&&!u.value&&h()}}};export{J as u};
