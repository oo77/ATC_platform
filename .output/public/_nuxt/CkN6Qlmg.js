import{_ as Q}from"./BMofnORk.js";import{v as X,e as at,f as q,r as x,C as Z,g as nt,k as G,b as _,w as g,T as J,K as lt,c as n,h as k,z as I,a as t,t as u,x as A,d as f,A as O,n as E,F as K,j as Y,o as r}from"./GLV6bXvn.js";import{u as tt}from"./DlZaGH1J.js";import{u as et}from"./DVL-QcDc.js";import{_ as it}from"./Caj9Z7Wo.js";import{_ as dt}from"./BNigTcCY.js";import{_ as ut}from"./CyDLpZDf.js";const ct={key:0,class:"fixed inset-0 z-999999 flex items-center justify-center bg-black/80 px-4 py-5"},mt={class:"border-b border-stroke px-6 py-4 dark:border-strokedark flex items-center justify-between"},pt={class:"text-xl font-semibold text-black dark:text-white"},ft={class:"grid grid-cols-1 gap-6 sm:grid-cols-2"},kt={class:"sm:col-span-2"},gt={key:0,class:"mt-1 text-sm text-danger"},xt={key:0,class:"mt-1 text-sm text-danger"},bt={class:"relative"},vt={class:"relative"},yt={key:0,class:"absolute right-3 top-1/2 -translate-y-1/2"},ht={key:0,class:"absolute z-50 w-full mt-1 bg-white dark:bg-boxdark border border-stroke dark:border-strokedark rounded-lg shadow-lg max-h-60 overflow-y-auto"},wt=["onMousedown"],_t={class:"font-medium text-black dark:text-white"},Ct={key:0,class:"text-sm text-gray-500 dark:text-gray-400"},zt={class:"text-xs text-gray-400 dark:text-gray-500 mt-1"},Mt={key:1,class:"absolute z-50 w-full mt-1 bg-white dark:bg-boxdark border border-stroke dark:border-strokedark rounded-lg shadow-lg"},$t={class:"px-4 py-3 text-sm text-gray-500 dark:text-gray-400"},Nt={class:"flex items-center gap-2"},Dt={class:"font-medium text-black dark:text-white"},Bt={key:2,class:"mt-1 text-sm text-danger"},jt={key:0,class:"mt-1 text-sm text-danger"},Tt={class:"sm:col-span-2 mt-4 pt-4 border-t border-stroke dark:border-strokedark"},Vt={key:0,class:"bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg"},At={class:"mt-2 text-sm text-blue-600 dark:text-blue-400"},Ot={class:"font-mono"},Et={class:"font-mono"},Ft={class:"text-sm text-gray-600 dark:text-gray-400 mb-4"},Ut={class:"font-mono"},St={class:"flex flex-wrap gap-3"},Ht={key:0,class:"animate-spin w-4 h-4",fill:"none",viewBox:"0 0 24 24"},Lt={key:1,class:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},Pt={class:"mt-6 flex justify-end gap-4"},Rt=X({__name:"StudentFormModal",props:{student:{},isOpen:{type:Boolean}},emits:["close","submit"],setup(b,{emit:U}){const c=b,$=U,{authFetch:F}=tt(),{user:T}=at(),N=q(()=>T.value&&["ADMIN","MANAGER"].includes(T.value.role)),h=x(!1),w=x(!1),v=x(!1),S=x(!1),l=Z({}),C=et(),D=x(!1),z=x(!1),y=x([]);let B=null;const s=Z({fullName:"",pinfl:"",organization:"",department:"",position:"",accountPassword:""}),H=async()=>{if(c.student){v.value=!0;try{const p=await F(`/api/students/${c.student.id}/reset-password`,{method:"POST",body:{resetToPinfl:!0}});p.success?C.success(p.message||"Пароль сброшен на ПИНФЛ","Успешно"):C.error(p.message||"Ошибка сброса пароля","Ошибка")}catch(p){C.error(p.message||"Ошибка сброса пароля","Ошибка")}finally{v.value=!1}}},i=q(()=>c.student?"Редактировать студента":"Добавить студента"),o=q(()=>c.student?"Сохранить":"Создать"),j=(p,e)=>{switch(p){case"fullName":if(!e||e.trim().length<2)return"Ф.И.О должно содержать минимум 2 символа";break;case"pinfl":if(!e||!/^\d{14}$/.test(e))return"ПИНФЛ должен содержать ровно 14 цифр";break;case"organization":if(!e||e.trim().length<2)return"Название организации обязательно для заполнения";break;case"position":if(!e||e.trim().length<2)return"Должность обязательна для заполнения";break}return null},V=()=>{w.value=!1,setTimeout(()=>{$("close")},300)},L=async p=>{if(!p.trim()){y.value=[];return}D.value=!0;try{const e=await F(`/api/organizations/search?q=${encodeURIComponent(p.trim())}&limit=5`,{method:"GET"});e.success&&(y.value=e.data)}catch(e){console.error("Error searching organizations:",e),y.value=[]}finally{D.value=!1}},P=()=>{B&&clearTimeout(B),B=setTimeout(()=>{L(s.organization)},300)},m=p=>{s.organization=p.name,y.value=[],z.value=!1},W=()=>{setTimeout(()=>{z.value=!1},200)},st=async()=>{if(h.value)return;Object.keys(l).forEach(d=>delete l[d]);const p=["fullName","pinfl","organization","position"];let e=!1;for(const d of p){const a=s[d],M=j(d,a);M&&(l[d]=[M],C.error(M,"Ошибка валидации"),e=!0)}if(!e){h.value=!0;try{const d={fullName:s.fullName.trim(),pinfl:s.pinfl.trim(),organization:s.organization.trim(),department:s.department?.trim()||void 0,position:s.position.trim()};!c.student&&s.accountPassword&&(d.accountPassword=s.accountPassword),$("submit",d),V()}catch(d){if(console.error("Error saving student:",d),d.data?.errors){const a=d.data.errors;Object.assign(l,a),Object.entries(a).forEach(([M,R])=>{const ot={fullName:"Ф.И.О",pinfl:"ПИНФЛ",organization:"Организация",department:"Служба/Отдел",position:"Должность"}[M]||M,rt=Array.isArray(R)?R[0]:R;C.error(`${ot}: ${rt}`,"Ошибка валидации")})}else{const a=d.data?.message||"Произошла ошибка при сохранении";C.error(a,"Ошибка")}}finally{h.value=!1}}};return nt(()=>{setTimeout(()=>{w.value=!0},10),c.student&&(s.fullName=c.student.fullName,s.pinfl=c.student.pinfl,s.organization=c.student.organization,s.department=c.student.department||"",s.position=c.student.position)}),(p,e)=>{const d=Q;return r(),G(lt,{to:"body"},[_(J,{"enter-active-class":"transition-opacity duration-300 ease-out","enter-from-class":"opacity-0","enter-to-class":"opacity-100","leave-active-class":"transition-opacity duration-200 ease-in","leave-from-class":"opacity-100","leave-to-class":"opacity-0"},{default:g(()=>[w.value?(r(),n("div",ct,[_(J,{"enter-active-class":"transition-all duration-300 ease-out","enter-from-class":"opacity-0 scale-95 -translate-y-4","enter-to-class":"opacity-100 scale-100 translate-y-0","leave-active-class":"transition-all duration-200 ease-in","leave-from-class":"opacity-100 scale-100 translate-y-0","leave-to-class":"opacity-0 scale-95 -translate-y-4"},{default:g(()=>[w.value?(r(),n("div",{key:0,class:"w-full max-w-3xl rounded-lg bg-white dark:bg-boxdark shadow-xl",onClick:e[7]||(e[7]=I(()=>{},["stop"]))},[t("div",mt,[t("h3",pt,u(i.value),1),t("button",{onClick:V,class:"text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors"},[...e[8]||(e[8]=[t("svg",{class:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)])])]),t("form",{onSubmit:I(st,["prevent"]),class:"p-6"},[t("div",ft,[t("div",kt,[e[9]||(e[9]=t("label",{class:"mb-3 block text-sm font-medium text-black dark:text-white"},[f(" Ф.И.О "),t("span",{class:"text-danger"},"*")],-1)),A(t("input",{"onUpdate:modelValue":e[0]||(e[0]=a=>s.fullName=a),type:"text",placeholder:"Введите полное имя",class:E(["w-full rounded-lg border border-stroke bg-transparent py-3 px-5 outline-none focus:border-primary dark:border-form-strokedark dark:bg-form-input dark:focus:border-primary",{"border-danger":l.fullName}]),required:""},null,2),[[O,s.fullName]]),l.fullName?(r(),n("p",gt,u(l.fullName[0]),1)):k("",!0)]),t("div",null,[e[10]||(e[10]=t("label",{class:"mb-3 block text-sm font-medium text-black dark:text-white"},[f(" ПИНФЛ "),t("span",{class:"text-danger"},"*")],-1)),A(t("input",{"onUpdate:modelValue":e[1]||(e[1]=a=>s.pinfl=a),type:"text",placeholder:"14-значный ПИНФЛ",maxlength:"14",pattern:"[0-9]{14}",class:E(["w-full rounded-lg border border-stroke bg-transparent py-3 px-5 outline-none focus:border-primary dark:border-form-strokedark dark:bg-form-input dark:focus:border-primary font-mono",{"border-danger":l.pinfl}]),required:""},null,2),[[O,s.pinfl]]),l.pinfl?(r(),n("p",xt,u(l.pinfl[0]),1)):k("",!0),e[11]||(e[11]=t("p",{class:"mt-1 text-xs text-gray-500 dark:text-gray-400"}," 14 цифр без пробелов ",-1))]),t("div",bt,[e[15]||(e[15]=t("label",{class:"mb-3 block text-sm font-medium text-black dark:text-white"},[f(" Организация "),t("span",{class:"text-danger"},"*")],-1)),t("div",vt,[A(t("input",{"onUpdate:modelValue":e[2]||(e[2]=a=>s.organization=a),type:"text",placeholder:"Введите название организации",class:E(["w-full rounded-lg border border-stroke bg-transparent py-3 px-5 outline-none focus:border-primary dark:border-form-strokedark dark:bg-form-input dark:focus:border-primary",{"border-danger":l.organization}]),required:"",autocomplete:"off",onInput:P,onFocus:e[3]||(e[3]=a=>z.value=!0),onBlur:W},null,34),[[O,s.organization]]),D.value?(r(),n("div",yt,[...e[12]||(e[12]=[t("svg",{class:"animate-spin h-5 w-5 text-primary",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24"},[t("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"}),t("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})],-1)])])):k("",!0)]),z.value&&y.value.length>0?(r(),n("div",ht,[(r(!0),n(K,null,Y(y.value,a=>(r(),n("button",{key:a.id,type:"button",class:"w-full px-4 py-3 text-left hover:bg-gray-50 dark:hover:bg-meta-4 transition-colors border-b border-stroke dark:border-strokedark last:border-b-0",onMousedown:I(M=>m(a),["prevent"])},[t("div",_t,u(a.name),1),a.shortName?(r(),n("div",Ct,u(a.shortName),1)):k("",!0),t("div",zt,u(a.studentsCount)+" слушателей ",1)],40,wt))),128))])):k("",!0),z.value&&s.organization.trim()&&y.value.length===0&&!D.value?(r(),n("div",Mt,[t("div",$t,[t("span",Nt,[e[13]||(e[13]=t("svg",{class:"w-4 h-4 text-primary",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 4v16m8-8H4"})],-1)),e[14]||(e[14]=f(" Будет создана новая организация: ",-1)),t("span",Dt,u(s.organization.trim()),1)])])])):k("",!0),l.organization?(r(),n("p",Bt,u(l.organization[0]),1)):k("",!0)]),t("div",null,[e[16]||(e[16]=t("label",{class:"mb-3 block text-sm font-medium text-black dark:text-white"}," Служба/Отдел ",-1)),A(t("input",{"onUpdate:modelValue":e[4]||(e[4]=a=>s.department=a),type:"text",placeholder:"Введите название службы или отдела",class:"w-full rounded-lg border border-stroke bg-transparent py-3 px-5 outline-none focus:border-primary dark:border-form-strokedark dark:bg-form-input dark:focus:border-primary"},null,512),[[O,s.department]])]),t("div",null,[e[17]||(e[17]=t("label",{class:"mb-3 block text-sm font-medium text-black dark:text-white"},[f(" Должность "),t("span",{class:"text-danger"},"*")],-1)),A(t("input",{"onUpdate:modelValue":e[5]||(e[5]=a=>s.position=a),type:"text",placeholder:"Введите должность",class:E(["w-full rounded-lg border border-stroke bg-transparent py-3 px-5 outline-none focus:border-primary dark:border-form-strokedark dark:bg-form-input dark:focus:border-primary",{"border-danger":l.position}]),required:""},null,2),[[O,s.position]]),l.position?(r(),n("p",jt,u(l.position[0]),1)):k("",!0)]),t("div",Tt,[c.student?N.value?(r(),n(K,{key:1},[e[28]||(e[28]=t("h4",{class:"font-medium text-black dark:text-white mb-3"}," Управление учётной записью ",-1)),t("p",Ft,[e[22]||(e[22]=f(" Email для входа: ",-1)),t("span",Ut,u(c.student.pinfl)+"@student.local",1)]),t("div",St,[_(d,{type:"button",variant:"secondary",size:"sm",onClick:H,disabled:v.value},{icon:g(()=>[v.value?(r(),n("svg",Ht,[...e[23]||(e[23]=[t("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"},null,-1),t("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"},null,-1)])])):(r(),n("svg",Lt,[...e[24]||(e[24]=[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"},null,-1)])]))]),default:g(()=>[e[25]||(e[25]=f(" Сбросить пароль на ПИНФЛ ",-1))]),_:1},8,["disabled"]),_(d,{type:"button",variant:"outline",size:"sm",onClick:e[6]||(e[6]=a=>S.value=!0)},{icon:g(()=>[...e[26]||(e[26]=[t("svg",{class:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"})],-1)])]),default:g(()=>[e[27]||(e[27]=f(" Изменить пароль ",-1))]),_:1})])],64)):k("",!0):(r(),n("div",Vt,[e[21]||(e[21]=t("div",{class:"flex items-center gap-2 text-blue-700 dark:text-blue-300"},[t("svg",{class:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})]),t("span",{class:"font-medium"},"Учётная запись создаётся автоматически")],-1)),t("p",At,[e[18]||(e[18]=f(" Логин: ",-1)),t("span",Ot,u(s.pinfl||"ПИНФЛ")+"@student.local",1),e[19]||(e[19]=t("br",null,null,-1)),e[20]||(e[20]=f(" Пароль: ",-1)),t("span",Et,u(s.pinfl||"ПИНФЛ"),1)])]))])]),t("div",Pt,[_(d,{variant:"danger",onClick:V,disabled:h.value},{default:g(()=>[...e[29]||(e[29]=[f(" Отмена ",-1)])]),_:1},8,["disabled"]),_(d,{variant:"success",type:"submit",loading:h.value},{default:g(()=>[f(u(o.value),1)]),_:1},8,["loading"])])],32)])):k("",!0)]),_:1})])):k("",!0)]),_:1})])}}}),fe=Object.assign(Rt,{__name:"DatabaseStudentFormModal"}),qt={class:"space-y-6"},It={class:"flex justify-end"},Gt={key:0,class:"space-y-4"},Kt={class:"flex items-start justify-between"},Wt={class:"flex-1 space-y-3"},Zt={class:"text-lg font-semibold text-black dark:text-white"},Jt={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},Qt={class:"font-medium text-black dark:text-white font-mono"},Xt={class:"font-medium text-black dark:text-white"},Yt={key:0},te={key:0,class:"text-xs"},ee={key:1},se=["href","download"],oe={class:"flex items-center gap-2 ml-4"},re={key:1,class:"text-center py-12"},ae=X({__name:"StudentCertificatesModal",props:{student:{},isOpen:{type:Boolean}},emits:["close","refresh"],setup(b,{emit:U}){const{authFetch:c}=tt(),$=et(),F=b,T=U,N=x(!1),h=x(!1),w=x(!1),v=x(null),S=()=>{N.value=!0},l=()=>{N.value=!1},C=()=>{l(),T("refresh")},D=i=>{const o=F.student?.certificates.find(j=>j.id===i);o&&(v.value=o,h.value=!0)},z=async()=>{if(v.value){w.value=!0;try{const i=await c(`/api/certificates/${v.value.id}`,{method:"DELETE"});i.success?(T("refresh"),$.success("Сертификат успешно удален","Успех"),y()):$.error(i.message||"Не удалось удалить сертификат","Ошибка")}catch(i){console.error("Ошибка удаления сертификата:",i);const o=i?.data?.message||i?.message||"Произошла ошибка при удалении сертификата";$.error(o,"Ошибка")}finally{w.value=!1}}},y=()=>{h.value=!1,v.value=null,w.value=!1},B=i=>new Date(i).toLocaleDateString("ru-RU",{year:"numeric",month:"long",day:"numeric"}),s=i=>new Date(i)<new Date,H=i=>`Сертификат_${i.certificateNumber.replace(/[^a-zA-Z0-9]/g,"_")}.pdf`;return(i,o)=>{const j=Q,V=it,L=dt,P=ut;return r(),G(P,{"is-open":b.isOpen,onClose:o[0]||(o[0]=m=>i.$emit("close")),title:`Сертификаты - ${b.student?.fullName||""}`,size:"lg"},{default:g(()=>[t("div",qt,[t("div",It,[_(j,{variant:"primary",onClick:S,class:"flex items-center gap-2"},{default:g(()=>[...o[1]||(o[1]=[t("svg",{class:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 4v16m8-8H4"})],-1),f(" Добавить сертификат ",-1)])]),_:1})]),b.student&&b.student.certificates.length>0?(r(),n("div",Gt,[(r(!0),n(K,null,Y(b.student.certificates,m=>(r(),n("div",{key:m.id,class:"rounded-lg border border-stroke bg-white p-6 dark:border-strokedark dark:bg-boxdark"},[t("div",Kt,[t("div",Wt,[t("div",null,[t("h4",Zt,u(m.courseName),1)]),t("div",Jt,[t("div",null,[o[2]||(o[2]=t("p",{class:"text-sm text-gray-600 dark:text-gray-400"},"Номер сертификата:",-1)),t("p",Qt,u(m.certificateNumber),1)]),t("div",null,[o[3]||(o[3]=t("p",{class:"text-sm text-gray-600 dark:text-gray-400"},"Дата получения:",-1)),t("p",Xt,u(B(m.issueDate)),1)]),m.expiryDate?(r(),n("div",Yt,[o[4]||(o[4]=t("p",{class:"text-sm text-gray-600 dark:text-gray-400"},"Срок годности:",-1)),t("p",{class:E(["font-medium",s(m.expiryDate)?"text-danger":"text-black dark:text-white"])},[f(u(B(m.expiryDate))+" ",1),s(m.expiryDate)?(r(),n("span",te,"(Истек)")):k("",!0)],2)])):k("",!0),m.fileUrl?(r(),n("div",ee,[o[6]||(o[6]=t("p",{class:"text-sm text-gray-600 dark:text-gray-400"},"Файл:",-1)),t("a",{href:m.fileUrl,download:H(m),target:"_blank",rel:"noopener noreferrer",class:"inline-flex items-center gap-1 text-primary hover:underline cursor-pointer"},[...o[5]||(o[5]=[t("svg",{class:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})],-1),f(" Скачать ",-1)])],8,se)])):k("",!0)])]),t("div",oe,[_(j,{variant:"danger",size:"sm",onClick:W=>D(m.id),title:"Удалить сертификат"},{default:g(()=>[...o[7]||(o[7]=[t("svg",{class:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1-1v3M4 7h16"})],-1)])]),_:1},8,["onClick"])])])]))),128))])):(r(),n("div",re,[...o[8]||(o[8]=[t("svg",{class:"mx-auto h-12 w-12 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})],-1),t("p",{class:"mt-4 text-gray-600 dark:text-gray-400"}," У этого студента пока нет сертификатов ",-1)])]))]),N.value&&b.student?(r(),G(V,{key:0,"preselected-student":b.student,"is-open":N.value,onClose:l,onCreated:C},null,8,["preselected-student","is-open"])):k("",!0),_(L,{"is-open":h.value,title:"Подтверждение удаления",message:"Вы уверены, что хотите удалить этот сертификат?","item-name":v.value?.courseName,warning:"Это действие нельзя отменить","confirm-text":"Удалить","cancel-text":"Отмена",variant:"danger",loading:w.value,onConfirm:z,onCancel:y},null,8,["is-open","item-name","loading"])]),_:1},8,["is-open","title"])}}}),ke=Object.assign(ae,{__name:"DatabaseStudentCertificatesModal"});export{fe as _,ke as a};
