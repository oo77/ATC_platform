# Предложение по системе пересдач и оценивания

В данном документе описаны предложения по реализации системы пересдач (Retake), отвязке тестов от учебной программы и системе оценок для практических занятий, с минимальным влиянием на текущую структуру БД.

## 1. Система пересдач (Retake Logic)

**Задача:** Позволить студентам, не набравшим проходной балл, пересдать тест после окончания курса в назначенное модератором время.

**Концепция:** "Целевые события пересдачи".
Вместо изменения логики существующих тестов, мы будем создавать **новое событие в расписании**, которое доступно **только** выбранным студентам (тем, кто пересдает).

### Предлагаемые изменения:

1.  **База данных (Минимальное изменение):**

    - В таблицу `test_assignments` добавить поле `allowed_student_ids` (JSON, nullable).
    - _Логика:_ Если поле `NULL` — тест доступен всей группе (стандартное поведение). Если массив ID (например, `["student1_id", "student3_id"]`) — доступ имеют только эти студенты.

2.  **Интерфейс Модератора (Новый функционал):**

    - На странице результатов группы добавить кнопку **"Назначить пересдачу"**.
    - **Workflow:**
      1. Модератор выбирает студентов с неудовлетворительной оценкой.
      2. Нажимает "Назначить пересдачу".
      3. Открывается модальное окно создания события расписания (дата, время, аудитория).
      4. Система автоматически создает:
         - Событие в `schedule_events` (Тип: `assessment`, Название: "Пересдача: [Название теста]").
         - Запись в `test_assignments` с тем же шаблоном теста, но с заполненным полем `allowed_student_ids`.

3.  **Интерфейс Студента:**
    - Студенты из списка `allowed_student_ids` увидят это событие в своем расписании и получат доступ к тесту.
    - Остальные студенты группы это событие не увидят (или увидят как недоступное).

**Почему это хорошо:**

- Не ломает текущую логику групп и расписания.
- Использует существующие механизмы `test_assignments` и `schedule_events`.
- Позволяет гибко назначать дату и время пересдачи.

---

## 2. Отвязка тестов от Учебной программы

**Задача:** Убрать выбор шаблонов тестов при создании Дисциплины/Программы. Выбирать тест только при планировании события в расписании (Проверка знаний).

### Предлагаемые изменения:

1.  **Создание программы (Admin/Manager UI):**

    - В компоненте `DisciplineFormModal` (или `DisciplineTestsSection`) **скрыть или сделать необязательным** блок выбора шаблонов тестов.
    - Таблицу `discipline_tests` можно оставить как "Рекомендованные тесты" (справочно), но не использовать жестко. Или полностью игнорировать.

2.  **Планирование расписания (Schedule UI):**

    - В модальном окне создания события расписания (`EventModal` или аналог):
    - Когда выбран тип события **"Проверка знаний" (Assessment)** -> Появляется **обязательное** поле: **"Выберите шаблон теста"**.
    - Список шаблонов загружается из всех активных `test_templates` (можно фильтровать по банку вопросов или названию).

3.  **Бэкенд:**
    - При создании события типа `assessment` бэкенд должен требовать `test_template_id` и создавать запись в `test_assignments`.
    - (Сейчас эта логика, возможно, опирается на привязку к дисциплине, её нужно переключить на прямой выбор из UI).

**Результат:** Тест назначается "по факту" в момент планирования, что дает гибкость модераторам менять тесты без изменения утвержденной учебной программы.

---

## 3. Система оценок для ПРАКТИКИ

**Задача:** Инструктор должен иметь возможность выставлять баллы за занятия типа "Практика".

**Концепция:** Использование существующей таблицы `grades`.

### Техническая реализация:

1.  **База данных:**

    - Таблица `grades` уже имеет связь `schedule_event_id` и `student_id`.
    - Для практических занятий (`event_type = 'practice'`) поле `is_from_test` будет `FALSE`.
    - Поле `grade` (0-100) будет заполняться вручную инструктором.

2.  **Интерфейс Инструктора (Журнал):**

    - На странице занятия (Журнал посещаемости):
    - Если тип занятия **"Практика"**, рядом с колонками посещаемости (Н/Б) добавить колонку **"Оценка"** (Input field).
    - Логика:
      - Инструктор вводит балл (0-100).
      - При потере фокуса или нажатии "Сохранить" отправляется запрос на API.
      - Данные пишутся в таблицу `grades`.

3.  **Бэкенд:**
    - Использовать (или расширить) существующий эндпоинт выставления оценок (например, ручное редактирование оценок).
    - Убедиться, что при расчете итоговой оценки по дисциплине (`Final Grade`) учитываются оценки за практические занятия (среднее арифметическое или взвешенное).

---

## Итоговый план действий (Checklist)

1.  [ ] **Миграция БД**: Добавить `allowed_student_ids` (JSON) в `test_assignments`.
2.  [ ] **Frontend (Schedule)**:
    - Добавить выбор `test_template_id` при создании события типа `Assessment`.
    - Реализовать модалку "Назначить пересдачу" для Модератора.
3.  [ ] **Frontend (Programs)**: Убрать обязательность/блок выбора тестов из `DisciplineForm`.
4.  [ ] **Frontend (Journal)**: Добавить колонку "Оценка" для практических занятий.
5.  [ ] **Backend**:
    - Обновить логику доступа к тесту (проверка `allowed_student_ids`).
    - API для сохранения ручных оценок за практики.
