# Исправление Telegram Mini App

## Проблемы, которые были исправлены

### 1. Mixed Content Error (WSS/WS)
**Проблема:** Приложение загружено через HTTPS (ngrok), но пыталось подключиться к WebSocket через незащищенный WS протокол.

**Решение:** Обновлена конфигурация Vite HMR в `nuxt.config.ts`:
- Используется WSS (защищенный WebSocket) вместо WS
- HMR подключается к ngrok домену вместо localhost
- Добавлена поддержка `.ngrok-free.dev` доменов

### 2. Ошибка авторизации в режиме разработки
**Проблема:** При открытии `/tg-app` вне Telegram, `initData` был пустым, что вызывало ошибку "Не удалось получить данные авторизации".

**Решение:** Добавлен режим разработки (DEV MODE):
- В `app/pages/tg-app/index.vue` добавлена поддержка mock данных
- В `server/api/tg-app/auth.post.ts` добавлена обработка dev режима
- Теперь можно тестировать приложение в браузере без Telegram

## Инструкции по применению изменений

### Шаг 1: Перезапустить dev сервер

Остановите текущий процесс `npm run dev` (Ctrl+C) и запустите заново:

```bash
npm run dev
```

### Шаг 2: Перезапустить ngrok (если нужно)

Если ngrok уже запущен, можете оставить как есть. Если нет:

```bash
npm run ngrok:config
```

### Шаг 3: Очистить кэш браузера

В Telegram Mini App или браузере:
1. Откройте DevTools (F12)
2. Очистите кэш и перезагрузите страницу (Ctrl+Shift+R или Cmd+Shift+R)

### Шаг 4: Тестирование в режиме разработки

Теперь вы можете открыть `/tg-app` в обычном браузере для тестирования:

```
https://charlena-nonarbitrable-eddy.ngrok-free.dev/tg-app
```

Приложение автоматически определит, что запущено вне Telegram, и использует mock данные:
- Chat ID: `123456789`
- Имя: `Dev User`
- Username: `devuser`

**ВАЖНО:** Для полноценного тестирования создайте тестового представителя с `telegramChatId = '123456789'` в базе данных.

### Шаг 5: Создание тестового представителя (опционально)

Если вы хотите протестировать полный функционал, создайте тестового представителя:

1. Откройте админ панель
2. Перейдите в раздел "Представители организаций"
3. Создайте нового представителя с:
   - Telegram Chat ID: `123456789`
   - Telegram Username: `devuser`
   - Статус: `approved`
   - Настройте необходимые права доступа

## Проверка работоспособности

После перезапуска проверьте:

1. ✅ HMR работает без ошибок Mixed Content
2. ✅ Страница `/tg-app` открывается без запроса авторизации
3. ✅ В консоли браузера нет ошибок WebSocket
4. ✅ В dev режиме показывается форма регистрации или данные представителя

## Логи для отладки

В консоли браузера вы должны увидеть:

```
[DEV MODE] Telegram WebApp недоступен, используем mock данные
[DEV MODE] Используем mock chatId для тестирования
```

Если видите эти сообщения - всё работает правильно!

## Для продакшена

В продакшене (когда приложение запущено в реальном Telegram):
- Mock данные **не используются**
- Проверяется реальный `initData` от Telegram
- Все работает как обычное Telegram Mini App

## Дополнительные настройки

### Изменить ngrok домен

Если вы получили новый ngrok домен, обновите:

1. `.env`:
```bash
NGROK_DOMAIN=ваш-новый-домен.ngrok-free.dev
```

2. `ngrok.yml`:
```yaml
domain: ваш-новый-домен.ngrok-free.dev
```

3. Перезапустите оба процесса (dev server и ngrok)

### Изменить тестовый Chat ID

Если хотите использовать другой тестовый Chat ID, измените в:

1. `app/pages/tg-app/index.vue` (строка ~192):
```javascript
chatId: 123456789, // ваш ID
```

2. `server/api/tg-app/auth.post.ts` (строка ~26):
```typescript
chatId = '123456789'; // ваш ID
```

## Возможные проблемы

### HMR всё ещё не работает

1. Проверьте, что в `.env` указан правильный `NGROK_DOMAIN`
2. Убедитесь, что dev сервер перезапущен
3. Очистите кэш браузера полностью

### Ошибка "Пользователь не найден"

Это нормально в dev режиме, если вы не создали тестового представителя. Приложение покажет форму регистрации.

### Приложение не работает в реальном Telegram

Убедитесь, что:
1. В BotFather настроен правильный URL Mini App
2. URL указывает на ваш ngrok домен: `https://charlena-nonarbitrable-eddy.ngrok-free.dev/tg-app`
3. Ngrok запущен и работает

## Контакты для помощи

Если возникли проблемы, проверьте:
- Консоль браузера (F12 → Console)
- Логи dev сервера
- Логи ngrok

---

**Последнее обновление:** 2026-01-25
